pkgname=busybox
pkgver=1.33.1
pkgrel=0
pkgdesc="Size optimized toolbox of many common UNIX utilities"
url="https://busybox.net/"
arch="all"
license="GPL-2.0"
makedepends="linux-dev bash"
checkdepends="zip"
triggers="busybox.trigger=/usr/bin"
provides="/bin/sh"
source="https://busybox.net/downloads/$pkgname-$pkgver.tar.bz2
	busyboxconfig"

builddir="$srcdir"/$pkgname-$pkgver

prepare() {
	default_prepare

	# Fails in containers (lack of permission)
	rm "$builddir"/testsuite/mdev.tests

	cp -v $srcdir/busyboxconfig .config
}

build() {
	make CC=$CC HOSTCC=$CC CFLAGS="-O0"
}

check() {
	SKIP_KNOWN_BUGS=1 make V=1 CC=$CC HOSTCC=$CC CFLAGS="-O0" check
}

package() {
	mkdir -p $pkgdir/usr/bin
	install -m755 $builddir/busybox "$pkgdir"/usr/bin/busybox
}

aalt() {
	depends="$depends aalt"
	pkgdesc="$pkgdesc (AAlt registration files)"
	install_if="aalt ${subpkgname%-aalt}=$pkgver-r$pkgrel"

	for a in $("$pkgdir"/usr/bin/busybox --list)
	do
		DESTDIR="$subpkgdir" aalt-bin -R -g busybox -p "$a" -f /usr/bin/busybox
	done
}

b2sums="2dce3427ab7703c56cbb3bdc0c93c1fe1c6dc24c5b467b6213b8f9cf55223ec63136b3837970e41293cc3d55d320599945d29a69a4ef8b4b3ab9fb5e2a527632  busybox-1.33.1.tar.bz2
5e58af938584edebf0c097bd2e58deb3b1376281d8cd54f2bc9b600d33d7fc5f0cba5ce28138f1f05a651fec4afd6bccd1a28b831358f752fcca7b6d4b46dfd6  busyboxconfig"

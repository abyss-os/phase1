pkgname=containerd

# NOTE: containerd's Makefile tries to get REVISION from git, but we're building from a tarball.
_commit=814b7956fafc7a0980ea07e950f983d0837e5578
pkgver=1.3.4
pkgrel=1
pkgdesc="An open and reliable container runtime"
url="https://containerd.io"
arch="all"
license="Apache-2.0"
depends="runc"
makedepends="btrfs-progs-dev go go-md2man libseccomp-dev"
#subpackages="$pkgname-doc"
source="containerd-$pkgver.tar.gz::https://github.com/containerd/containerd/archive/v$pkgver.tar.gz
	make-buildmode-configurable.patch
	lol_go.patch"
#builddir="$srcdir/src/github.com/containerd/containerd"
options="!strip"

prepare() {
	cd $srcdir
	default_prepare
}

build() {
	case "$CARCH" in
		mips64*) buildmode=exe;;
		*) buildmode=pie;;
	esac

	export GOPATH="$srcdir"
	cd "$srcdir"
	mkdir -p $(dirname "$srcdir/src/github.com/containerd/containerd")
	ln -s "$PWD/$pkgname-$pkgver" "$srcdir/src/github.com/containerd/containerd"
	cd "$srcdir/src/github.com/containerd/containerd"
	make VERSION="v$pkgver" REVISION="$_commit" BUILDMODE=${buildmode}
	# new generated manpages
	#make genman
}

check() {
	./bin/containerd --version
}

package() {
	install -d "$pkgdir"/usr/bin/
	install -Dsm755 "$builddir"/bin/* "$pkgdir"/usr/bin/
}

b2sums="9d5642399eafbf3df25d2bdb6ffeb8e98362e9f2c6cdcd7a64fff12bad40f58fa97451228a607def408cc8a8cfbfce67c47fcfdf86865d8086d0b7aad7595d5a  containerd-1.3.4.tar.gz
4aeb50c9ed4187cbe88208f33e8360a3b1c7d4ca5e073b6be82ef19260fc77fe82363f86255178f58d065446283e21a3b53421f3970c71e24647d6cdcf23841a  make-buildmode-configurable.patch
04a645e3140c67f2fd8bc380c9e9cc834bee3eb638d0a2515b16b14b474d986d1eadaf5836620f67e5e03a3d7ee8bb89838f698bd03fd5ffd9a24a481352a9c2  lol_go.patch"

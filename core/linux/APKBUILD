pkgname=linux
pkgver=5.4.6
pkgrel=0
pkgdesc="Linux kernel"
url="http://kernel.org"
#depends="mkinitfs"
_depends_dev="perl elfutils-dev bash flex bison binutils"
makedepends="$_depends_dev gsed bc linux-dev openssl-dev"
options="!strip"
_config=${config:-config-vanilla.${CARCH}}
install=
source="https://cdn.kernel.org/pub/linux/kernel/v${pkgver%%.*}.x/linux-$pkgver.tar.xz
	config.aarch64
	config.x86_64
	config.riscv64
	"
subpackages="$pkgname-dev"

arch="all"
license="GPL-2.0"

_carch=${CARCH}
case "$_carch" in
aarch64*) _carch="arm64" ;;
mips*) _carch="mips" ;;
ppc*) _carch="powerpc" ;;
x86*) _carch="x86" ;;
riscv64*) _carch="riscv" ;;
*) error "Unsupported architecture" ;;
esac

prepare() {
	default_prepare
	mkdir -p ${srcdir}/build && cd ${srcdir}/build
	cp -v ${srcdir}/config.${CARCH} ${srcdir}/build/.config
	make -C ${srcdir}/linux-${pkgver} O=${srcdir}/build \
		ARCH="$_carch" HOSTCC="$CC" CC="$CC" AS=gnu-as HOSTAS=gnu-as \
		HOSTLD=$LD LD=$LD OBJCOPY=gnu-objcopy STRIP=gnu-strip \
		listnewconfig oldconfig
		
}

build() {
	cd ${srcdir}/build
	make -C ${srcdir}/linux-${pkgver} O=${srcdir}/build \
		ARCH="$_carch" HOSTCC="$CC" CC="$CC" AS=gnu-as HOSTAS=gnu-as \
		HOSTLD=$LD LD=$LD OBJCOPY=gnu-objcopy STRIP=gnu-strip \
		KBUILD_BUILD_VERSION="$((pkgrel + 1 ))-abyss"
}

package() {
	cd ${srcdir}/build
	mkdir -p ${pkgdir}/boot ${pkgdir}/lib/modules

	case "$CARCH" in
		arm*)
			mkdir -p ${pkgdir}/boot/dtb
			for i in arch/arm/boot/dts/*.dtb; do
				install -m644 "$i" ${pkgdir}/boot/dtb/
			done
			;;
		*)
			;;
	esac

	# modules are disabled at the moment
	#make
	#	ARCH="$_carch" HOSTCC="$CC" CC="$CC" AS=gnu-as HOSTAS=gnu-as \
	#	HOSTLD=$LD LD=$LD OBJCOPY=gnu-objcopy STRIP=gnu-strip \
	#	INSTALL_MOD_PATH="$pkgdir" INSTALL_PATH="$pkgdir/boot" INSTALL_HDR_PATH="$pkgdir/usr" install modules_install headers_install
	make \
		ARCH="$_carch" HOSTCC="$CC" CC="$CC" AS=gnu-as HOSTAS=gnu-as \
		HOSTLD=$LD LD=$LD OBJCOPY=gnu-objcopy STRIP=gnu-strip \
		INSTALL_MOD_PATH="$pkgdir" INSTALL_PATH="$pkgdir/boot" INSTALL_HDR_PATH="$pkgdir/usr" install headers_install
}

b2sums="8619492fedd4ae489a811561f72285b69deb827bb1db1f65be2a128d3bcbb69bdeec6b73650e1e8f72b18e5016c2df092bc77ee38be756d35f2903ecf0db1687  linux-5.4.6.tar.xz
f4ced3fbc0b7f68d268b808e669a8c2ab161f4bf0597f66eecacb4d7537faab8ce42df3456ec3eed1520674c381b67e136fa90cc4971b12cd801e72cffde1ded  config.aarch64
7c8d760112b6b878ebbc9a6a4981f8f66b4a9f652b3f75cb8177c00a8ea7c3dc08af86179915d9a03bf835a23dcff42e286f2f3656a65f21e5c729992facf6bb  config.x86_64
d7c54880b8af226309cbcd2492ab2f2f3dd8b8facf9caad4eb7c097e7ff8c9c3c88802f65d7f5c738b3d173fe550a6662a56c68a024107ded1a8fcf11a17a572  config.riscv64"

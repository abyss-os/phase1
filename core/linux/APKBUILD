pkgname=linux
pkgver=5.13.13
_pkgver=${pkgver/_/-}
pkgrel=0
pkgdesc="Linux kernel"
url="http://kernel.org"
#depends="mkinitfs"
makedepends="bash flex bison gsed bc linux-dev openssl-dev findutils rsync ncurses-dev"
options="!strip"
source="https://cdn.kernel.org/pub/linux/kernel/v${pkgver%%.*}.x/linux-$pkgver.tar.xz
	config.aarch64
	config.x86_64
	config.riscv64
	config.mips64
	config.mips64el
	config.ppc64le
	"
install="$pkgname.pre-upgrade"
subpackages="$pkgname-dev"

arch="all"
license="GPL-2.0"

builddir="$srcdir"/linux-"$_pkgver"
_builddir="$srcdir"/build

# map for CARCH->kernel arch
case $CARCH in
    x86_64) KARCH=x86;;
    aarch64) KARCH=arm64;;
    mips64*) KARCH=mips;;
    ppc64le) KARCH=powerpc;;
    riscv64) KARCH=riscv;;
    *) msg "Unknown arch"; return 1;;
esac

prepare() {
	default_prepare
	mkdir -p "$_builddir" && cd "$_builddir"
	cp -v "$srcdir"/config."${ARCH:-$CARCH}" .config

	_make listnewconfig oldconfig
}

build() {
	cd "$_builddir"
	case $CARCH in
		ppc64le|riscv64) _make headers ;;
		*) _make ;;
	esac
}

package() {
	cd "$_builddir"
	install -d "$pkgdir"/boot "$pkgdir"/lib/modules

	case "$CARCH" in
		arm*)
			install -d "$pkgdir"/boot/dtb
			for i in arch/arm/boot/dts/*.dtb; do
				install -m644 "$i" ${pkgdir}/boot/dtb/
			done
			;;
	esac

	# modules are disabled at the moment
	#_make install modules_install headers_install
	case $CARCH in
		ppc64le|mips64*|riscv64) _make headers_install ;;
		*) _make install headers_install ;;
	esac

	install -d "$pkgdir"/usr
	mv -v "$pkgdir"/lib "$pkgdir"/usr/

    mv -v $pkgdir/boot/vmlinuz $pkgdir/boot/vmlinuz-$pkgver
}

# DO NOT USE THESE FUNCTIONS UNLESS YOU'RE A DEV AND KNOW WHAT YOU'RE DOING AND WHY
_make() {
	make -j${JOBS} -C "$builddir" O="$_builddir" \
		LLVM=1 LLVM_IAS=1 \
		KBUILD_BUILD_VERSION="$(( pkgrel + 1 ))-abyss" \
		INSTALL_MOD_PATH="$pkgdir"/usr \
		INSTALL_HDR_PATH="$pkgdir"/usr \
		INSTALL_PATH="$pkgdir"/boot \
        ARCH=$KARCH \
		"$@"
}
_oldconfig() {
	cd "$_builddir"
	cp -v "$srcdir"/config."$CARCH" .config
	_make oldconfig
	mv -v .config "$startdir"/config."$CARCH"
}
_menuconfig() {
	cd "$_builddir"
	[[ ! -f .config ]] && cp -v "$srcdir"/config."$CARCH" .config
	_make menuconfig
	cp -v .config "$startdir"/config."$CARCH"
}

b2sums="c763adef68a11c42a6e9435522300c5327a9dd3c8b25f1c41e0fdc536e224aac83dbb13d86bb52973304520f1cc28c4c9158baddf6087af54b1e5fbe010be485  linux-5.13.13.tar.xz
7d291a7657571e106c8a071420d7fa4bfccb97a3acff6533d746fcb222f022f51a1abf370289abdee3f17b40a724d8f01b37a7a865e0bbb4b166494980ce4a8d  config.aarch64
f906125cc6412148160a54cd5ebf8d63e2db45bbec32423133418b766ffa0c8531f48a9004da8b3a1a342535bcfa039edd9952fc0f08a0a97e9618c34236bdb3  config.x86_64
2c6ecaf3b29d9d12447bb7ea8f92eb4fdc052788904854b3f5e0f51328465e9d0a0ed474322c192b345d4e9a7b79b37a7c291e1cd6d0d699a6fbf9cb7b1fcfeb  config.riscv64
52df7f1ea912baa5f7efd0a2a71ef8843367fef6c833018d2f735d55d8518a932cbe8af6834b00cf6abb862b6754e0c2c59c8f9683d601ffde0144fac42dac26  config.mips64
e06144f0f241c43096d9dcc72d52166b3b449b0bdffd15ddf6f629157409d81972a0087d5073e2197293b4b517955a68cd48b199ec0a1a6a10c609e37d136a14  config.mips64el
1401196295273ae933b986a8b52276d678f58591c76b9626f96ffc414f889abcad08a6054bf92ed7395a774a48d3873794ed768658a028240c5271a7c4cf7363  config.ppc64le"

pkgname=linux
pkgver=5.7_rc2
_pkgver=${pkgver/_/-}
pkgrel=6
pkgdesc="Linux kernel"
url="http://kernel.org"
#depends="mkinitfs"
makedepends="perl elfutils-dev bash flex bison gsed bc linux-dev openssl-dev binutils findutils"
options="!strip"
#source="https://cdn.kernel.org/pub/linux/kernel/v${pkgver%%.*}.x/linux-$pkgver.tar.xz
source="https://git.kernel.org/torvalds/t/linux-${_pkgver}.tar.gz
	config.aarch64
	config.x86_64
	config.riscv64
	config.mips64
	config.mips64el
	"
subpackages="$pkgname-dev"

arch="all"
license="GPL-2.0"

builddir="$srcdir"/linux-"$_pkgver"
_builddir="$srcdir"/build

_carch=${CARCH}
case "$_carch" in
x86*) _carch="x86" archopts="LLVM=1" ;;
riscv64*) _carch="riscv" archopts="LLVM=1" ;;
aarch64*) _carch="arm64" archopts="LLVM=1" ;;
mips*) _carch="mips" archopts="LLVM=0 LLVM_IAS=0 HOSTLD=gnu-ld LD=gnu-ld HOSTCC=gnu-gcc CC=gnu-gcc" makedepends="$makedepends gcc" ;;
ppc*) _carch="powerpc" archopts="LLVM=0 LLVM_IAS=0 HOSTLD=gnu-ld LD=gnu-ld HOSTCC=gnu-gcc CC=gnu-gcc" makedepends="$makedepends gcc" ;;
*) error "Unsupported architecture" ;;
esac

prepare() {
	default_prepare
	mkdir -p "$_builddir" && cd "$_builddir"
	cp -v "$srcdir"/config."$CARCH" .config

	# sledgehammer, update build env
	export OTC="$(toolchain show)"
	msg "Updating buildenv (currently: ${OTC})..."
	toolchain none gnu

	#_make listnewconfig oldconfig
}

build() {
	cd "$_builddir"
	_make
	msg "Reverting buildenv ($OTC)..."
	toolchain $OTC
}

package() {
	cd "$_builddir"
	install -d "$pkgdir"/boot "$pkgdir"/lib/modules

	case "$CARCH" in
		arm*)
			install -d "$pkgdir"/boot/dtb
			for i in arch/arm/boot/dts/*.dtb; do
				install -m644 "$i" ${pkgdir}/boot/dtb/
			done
			;;
	esac

	# modules are disabled at the moment
	#_make install modules_install headers_install
	_make install headers_install

	install -d "$pkgdir"/usr
	mv -v "$pkgdir"/lib "$pkgdir"/usr/
}
# DO NOT USE THESE FUNCTIONS UNLESS YOU'RE A DEV AND KNOW WHAT YOU'RE DOING AND WHY
_make() {
	make -C "$builddir" O="$_builddir" \
		$archopts \
		KBUILD_BUILD_VERSION="$(( pkgrel + 1 ))-abyss" \
		INSTALL_MOD_PATH="$pkgdir"/usr \
		INSTALL_HDR_PATH="$pkgdir"/usr \
		INSTALL_PATH="$pkgdir"/boot \
		"$@"
}
_oldconfig() {
	cd "$_builddir"
	cp -v "$srcdir"/config."$CARCH" .config
	_make oldconfig
	mv -v .config "$startdir"/newconfig."$CARCH"
}
_menuconfig() {
	cd "$_builddir"
	cp -v "$srcdir"/config."$CARCH" .config
	_make menuconfig
	mv -v .config "$startdir"/newconfig."$CARCH"
}

b2sums="cdafe3e6278cac5a08b7ef8c8b26dc6e4278e9eafbb07b42ac4d5416f5b1318c2f2a84812c475e5a8ea3d9b151f5b7f84eaccd49740f48aeeb8a4164347cc610  linux-5.7-rc2.tar.gz
f4ced3fbc0b7f68d268b808e669a8c2ab161f4bf0597f66eecacb4d7537faab8ce42df3456ec3eed1520674c381b67e136fa90cc4971b12cd801e72cffde1ded  config.aarch64
442744a573d9eaaccabe0f5302c6ac3c9b66e15cd573c0cf494776c7d6fa9101b7911a0c93e2d321adf1bf2fff2de3cbebbf1c5e442b0944af7bfbde1669830a  config.x86_64
d7c54880b8af226309cbcd2492ab2f2f3dd8b8facf9caad4eb7c097e7ff8c9c3c88802f65d7f5c738b3d173fe550a6662a56c68a024107ded1a8fcf11a17a572  config.riscv64
f7ec2129f67b2f3656484e5933a4eea1e15b4f3bcdc477d045d7f152621709c8d5c44d575f0c1cbb80eda6af1b409b3a9688a415fa1b7f1ed47f8bf2ec01493b  config.mips64
f7ec2129f67b2f3656484e5933a4eea1e15b4f3bcdc477d045d7f152621709c8d5c44d575f0c1cbb80eda6af1b409b3a9688a415fa1b7f1ed47f8bf2ec01493b  config.mips64el"

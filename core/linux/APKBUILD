pkgname=linux
pkgver=5.12.1
_pkgver=${pkgver/_/-}
pkgrel=0
pkgdesc="Linux kernel"
url="http://kernel.org"
#depends="mkinitfs"
makedepends="bash flex bison gsed bc linux-dev openssl-dev findutils rsync ncurses-dev"
options="!strip"
source="https://cdn.kernel.org/pub/linux/kernel/v${pkgver%%.*}.x/linux-$pkgver.tar.xz
	kernel-no-perl.patch
	config.aarch64
	config.x86_64
	config.riscv64
	config.mips64
	config.mips64el
	config.ppc64le
	"
subpackages="$pkgname-dev"

arch="all"
license="GPL-2.0"

builddir="$srcdir"/linux-"$_pkgver"
_builddir="$srcdir"/build

prepare() {
	default_prepare
	mkdir -p "$_builddir" && cd "$_builddir"
	cp -v "$srcdir"/config."$CARCH" .config

	_make listnewconfig oldconfig
}

build() {
	cd "$_builddir"
	case $CARCH in
		ppc64le|riscv64) _make headers ;;
		*) _make ;;
	esac
}

package() {
	cd "$_builddir"
	install -d "$pkgdir"/boot "$pkgdir"/lib/modules

	case "$CARCH" in
		arm*)
			install -d "$pkgdir"/boot/dtb
			for i in arch/arm/boot/dts/*.dtb; do
				install -m644 "$i" ${pkgdir}/boot/dtb/
			done
			;;
	esac

	# modules are disabled at the moment
	#_make install modules_install headers_install
	case $CARCH in
		ppc64le|mips64*|riscv64) _make headers_install ;;
		*) _make install headers_install ;;
	esac

	install -d "$pkgdir"/usr
	mv -v "$pkgdir"/lib "$pkgdir"/usr/
}

# DO NOT USE THESE FUNCTIONS UNLESS YOU'RE A DEV AND KNOW WHAT YOU'RE DOING AND WHY
_make() {
	make -j${JOBS} -C "$builddir" O="$_builddir" \
		LLVM=1 LLVM_IAS=1 \
		KBUILD_BUILD_VERSION="$(( pkgrel + 1 ))-abyss" \
		INSTALL_MOD_PATH="$pkgdir"/usr \
		INSTALL_HDR_PATH="$pkgdir"/usr \
		INSTALL_PATH="$pkgdir"/boot \
		"$@"
}
_oldconfig() {
	cd "$_builddir"
	cp -v "$srcdir"/config."$CARCH" .config
	_make oldconfig
	mv -v .config "$startdir"/newconfig."$CARCH"
}
_menuconfig() {
	cd "$_builddir"
	[[ ! -f .config ]] && cp -v "$srcdir"/config."$CARCH" .config
	_make menuconfig
	cp -v .config "$startdir"/newconfig."$CARCH"
}

b2sums="71db3031f059b4411e542fb17acf15d9d2fcff10c35958f74b190f8a4cc352658f9101b34cd35a306d36f39a3c194cde1c3d5ad7a53a758bbe0a9671b8becdd3  linux-5.12.1.tar.xz
7d2686a5cbb0384e6daa7e1315988597fa4316913048ad0c8a118acc138403393843501549f6b4be0903b27abddba2bc2155b60d19116f51d8f225d950b403eb  kernel-no-perl.patch
5e7a2d34c0bbafc07bfbaf20cf55149a7ee46fc64cbae015618cf96d095a470361c972f1e838f00949a7aa05adb1a0713245db1f1e59d46776b32bdcdf07b685  config.aarch64
581744fecc3dc524af4343e91aabf7db25aa582e96bf1abf90c51deb188da48a467d153b08d220f63d1413267af24d7e5e26dc2a97d30c46721a9a11cbd3fb46  config.x86_64
d28e84afbc73cb9ae069b74ac12bf6c6f651d50665ae33d05e8ba6fd3ac7b3eed789858823b17cb3ea134cc1c76a501e722ebe1429cb45c627fe5e981c65fc42  config.riscv64
f7ec2129f67b2f3656484e5933a4eea1e15b4f3bcdc477d045d7f152621709c8d5c44d575f0c1cbb80eda6af1b409b3a9688a415fa1b7f1ed47f8bf2ec01493b  config.mips64
f7ec2129f67b2f3656484e5933a4eea1e15b4f3bcdc477d045d7f152621709c8d5c44d575f0c1cbb80eda6af1b409b3a9688a415fa1b7f1ed47f8bf2ec01493b  config.mips64el
d28e84afbc73cb9ae069b74ac12bf6c6f651d50665ae33d05e8ba6fd3ac7b3eed789858823b17cb3ea134cc1c76a501e722ebe1429cb45c627fe5e981c65fc42  config.ppc64le"

pkgname=lxd
pkgver=4.16
_qemu=5.2.0
pkgrel=0
pkgdesc="a container hypervisor and a new user experience for LXC"
url="https://linuxcontainers.org/lxd/"
arch="all"
license="Apache-2.0"
depends="netcat-openbsd cgmanager squashfs-tools rsync shadow lxc iptables dnsmasq gtar iproute2"
makedepends="lxc-dev go dqlite-dev raft-dev sqlite-dev libuv-dev libcap-dev eudev-dev acl-dev"
subpackages="$pkgname-bash-completion:bashcomp:noarch $pkgname-openrc"
install="$pkgname.pre-install"
options="!check"
source="https://linuxcontainers.org/downloads/$pkgname/$pkgname-$pkgver.tar.gz
	$pkgname.confd
	$pkgname.initd
	lxd-dont-go-get.patch
	add-missing-includes.patch
	seccomp_werror.patch"

build() {
	export GOPATH="$builddir/_dist" CGO_CFLAGS="-Wno-error -Wignored-attributes" GO111MODULE=auto

	go install -v -x -tags libsqlite3 github.com/lxc/lxd/lxd
	for bin in lxc fuidshift lxc-to-lxd lxd-benchmark lxd-p2c lxd-agent; do
		go install -v -x github.com/lxc/lxd/$bin
	done
}

package() {
	export GOPATH="$builddir/_dist"

	cd ${GOPATH}
	install -Dm755 bin/$pkgname "$pkgdir"/usr/bin/$pkgname
	install -Dm755 bin/lxc "$pkgdir"/usr/bin/lxc

	install -Dm755 "$srcdir"/lxd.initd \
		"$pkgdir"/etc/init.d/lxd
	install -Dm644 "$srcdir"/lxd.confd \
		"$pkgdir"/etc/conf.d/lxd

	for tool in fuidshift lxc-to-lxd lxd-benchmark lxd-p2c lxd-agent; do
		install -Dm755 bin/$tool "$pkgdir"/usr/bin/$tool
	done

}

bashcomp() {
	depends="bash"
	pkgdesc="Bash completions for $pkgname"
	install_if="$pkgname=$pkgver-r$pkgrel bash-completion"

	cd "$builddir"
	mkdir -p "$subpkgdir"/usr/share/bash-completion/completions
	cp scripts/bash/lxd-client "$subpkgdir"/usr/share/bash-completion/completions/lxd-client
}

b2sums="091139312459d458033013c200da327feb46c275b3504e5a712dd90be43528a2ae5078a62bd0925c9298ae145f974d808d4afa3b50e24f4a8ad755f4da453353  lxd-4.14.tar.gz
0c53ad54c956fa067e83ae53467cfcdb8ace2e14972b762dcf8715493d89a74da376f37386626b8b96b27df163e3d8ce13b96858191b6d0000d90a0ce08cc137  lxd.confd
ed0c53b6255a320ff8c1a41da70ff495395b9a99d305ca25f9e017f7821e9a1caaef26677bf448107e235b6ee10bcd1181150c299dce55c1e7b70f5686105650  lxd.initd
870d6d9a35ab4ccfb641531b5d806ef76c41deb22ad53bbe6af3d90a93252fc7a81428cd8557c7a42915880d4ff14d76d7fff3dccb2a10b989df4b9c5c616b16  lxd-dont-go-get.patch
7e6d3bf71a4d5a4b7fa46fe2e45c815782bb6337528c2c3026c1619abcae9ca89fc073a62b5ffaa6f84fe46650028e74a98fd40ed7e68a31df9c97b4a73474a6  add-missing-includes.patch
3d9b8bea9658c2fbed17c827343c6b17b4af6517eee4f431494209ae911eb0f31220ccf38749993bfa20731a410aa5a1ac03e9a15a8ca4deb42a8df40103d991  seccomp_werror.patch"

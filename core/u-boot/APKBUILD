pkgname=u-boot
pkgver=2020.04
pkgrel=0
pkgdesc="u-boot bootloader common files"
url="http://www.denx.de/wiki/U-Boot/"
arch="aarch64"
license="GPL-2.0-or-later OFL-1.1 BSD-2-Clause BSD-3-Clause eCos-2.0 IBM-pibs
	ISC LGPL-2.0-only LGPL-2.1-only X11"
makedepends="bc dtc python3-dev swig bison flex openssl-dev gcc"
source="ftp://ftp.denx.de/pub/u-boot/u-boot-${pkgver//_/-}.tar.bz2
	rpi.config"
builddir="$srcdir"/u-boot-${pkgver//_/-}

# supported boards
boards=""
case "$CARCH" in
	aarch64) boards="rpi";;

esac

build() {
	cd "$builddir"
	touch include/config.h
	LC_ALL=C date +'#define U_BOOT_DATE "%b %d %C%y"' > include/timestamp_autogenerated.h
	LC_ALL=C date +'#define U_BOOT_TIME "%T"' >> include/timestamp_autogenerated.h

	for board in $boards; do
		msg "Building u-boot for $board"

		export BUILD_DIR="$builddir"/build/$board
		mkdir -p "$BUILD_DIR"
		cp -v $srcdir/$board.config "$BUILD_DIR"/.config
		make HOSTCC=gnu-gcc CC=gnu-gcc O="$BUILD_DIR" all
	done
}

package() {
	cd "$builddir"/build
	mkdir -p "$pkgdir"/usr/bin
}

_split_boards() {
	cd "$builddir"/build
	pkgdesc="u-boot for $1"
	depends="u-boot"
	shift
	local board
	for board; do
		msg "Including board $board"
		mkdir -p "$subpkgdir"/usr/share/$pkgname/$board
		export BUILD_DIR="$builddir"/build/$board
		local ok=no
		for image in u-boot-sunxi-with-spl.bin -- MLO SPL u-boot.img -- u-boot.bin; do
			if [ "$image" = "--" ]; then
				[ "$ok" = yes ] && break
				continue
			fi
			if [ -e "$BUILD_DIR"/$image ]; then
				cp "$BUILD_DIR"/$image "$subpkgdir"/usr/share/$pkgname/$board \
					|| return 1
				ok=yes
			fi
		done
		[ "$ok" = yes ] || return 1
	done
}
b2sums="29cf8be6027ce46e3bf3fae9b6736e6aba46dba2904112f845d79f50b52b7c7ff3437c71dac6ab22d112347467fb5baaa3ec421cb842ba3ae9b547e4f8378d03  u-boot-2020.04.tar.bz2
f041a611249fca71c3bd36025f2ae708e69264c5190c08cbe8a1513c6303adc1b6e81f908a1e2bbafc20a49d2f1bfc738906ab826a620ec8b592f84a08cd36eb  rpi.config"

pkgname=binutils
pkgver=2.36.1
pkgrel=2
pkgdesc="Tools necessary to build programs"
url="https://www.gnu.org/software/binutils/"
makedepends="bison flex texinfo zlib-dev"
arch="all"
license="GPL-2.0 GPL-3.0-or-later LGPL-2.0 BSD"
subpackages="$pkgname-dev $pkgname-doc"
source="https://ftp.gnu.org/gnu/$pkgname/$pkgname-$pkgver.tar.bz2
	binutils-ld-fix-static-linking.patch
	gold-mips.patch
	mips64_default_emul.patch"

builddir="$srcdir/$pkgname-$pkgver"

build() {
	if [ "$CTARGET_ARCH" = "x86_64" ]; then
		_extra_args="--enable-targets=x86_64-pep"
	fi

	case "$CTARGET_ARCH" in
		mips*)  _extra_args="$_extra_args --enable-default-hash-style=sysv" ;;
		*)	_extra_args="$_extra_args --enable-default-hash-style=gnu" ;;
	esac

	./configure \
        --program-prefix=gnu- \
        --prefix=/usr \
        --mandir=/usr/share/man \
        --infodir=/usr/share/info \
        --sbindir=/usr/bin \
        --disable-multilib \
        --enable-ld=default \
        --enable-gold=yes \
        --enable-plugins \
        --enable-relro \
        --enable-deterministic-archives \
        --enable-install-libiberty \
        --enable-shared \
        --with-pic \
        --disable-werror \
        --disable-nls \
        --with-mmap \
        --with-system-zlib \
        --enable-lto \
        $_extra_args
    make
}

package() {
	make -j1 install DESTDIR="$pkgdir"
}

aalt() {
	depends="$depends aalt"
	pkgdesc="$pkgdesc (AAlt registration files)"
	install_if="aalt ${subpkgname%-aalt}=$pkgver-r$pkgrel"

	for p in strings ranlib c++filt readelf gprof dwp as addr2line strip size elfedit ar objcopy objdump nm
	do
		DESTDIR="$subpkgdir" aalt-bin -R -g gnu -p $p -f /usr/bin/gnu-$p
	done

	DESTDIR="$subpkgdir" aalt-bin -R -g gnu  -p ld -f /usr/bin/gnu-ld.bfd
	DESTDIR="$subpkgdir" aalt-bin -R -g gold -p ld -f /usr/bin/gnu-ld.gold
}

b2sums="23a6de4e3b9282d3977e22c8223389eac6beae64c2c4706c5754d0f59ae83c766493e5d6618c13095925375e589e99710dac56953d96b109946dc8034d823ccc  binutils-2.36.1.tar.bz2
ef739456181984b988abf9b6788319122284b879317868ff32750508166435f01af23839eff178e60092d55851c1cb6a2d1ca8d4e7c3a7a29be5be7997b7b5d7  binutils-ld-fix-static-linking.patch
411da71de153a922193ba1be212c86a0e5b6e6d4247fd18d24278453720b95724408ccad797a8f57758953ad958792230778d9cf49304a3678226de379e65fe3  gold-mips.patch
6603d36fb11d969952cd1100305d553838d3ae85e0bc6113b12b10399de1a7d50bfec732ad1f78795505b0b6a9d942764ae750bc06569616049fd82d9dcbe334  mips64_default_emul.patch"

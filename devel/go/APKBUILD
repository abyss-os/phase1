pkgname=go
pkgrel=1
pkgver=1.14.6
pkgdesc="Go programming language compiler"
url="https://golang.org/"
arch="all"
license="BSD-3-Clause"
makedepends="bash go-bootstrap"
subpackages="$pkgname-doc"
source="https://golang.org/dl/go${pkgver/_/}.src.tar.gz
	dont_use_gold_arm64.patch
	mips-fix-linker.patch
	fix-rlimit-syscall-aarch64-armv7.patch
	fix-setrlimit-hang.patch"
options="!check !strip"

case "$CTARGET_ARCH" in
	mips64*) export GOMIPS64=softfloat ;;
esac

export GOPATH="$srcdir"
export GOROOT="$GOPATH"/go
export builddir="$GOROOT"

provides="go-bootstrap=$pkgver-r$pkgrel"

GOROOT_FINAL=/usr/lib/go
GOROOT_BOOTSTRAP=$GOROOT_FINAL

build() {
	export GO_LDSO=/usr/lib/ld-musl-$(apk --print-arch).so.1
	case "$(apk --print-arch)" in
		mips64*) export GO_LDSO="${GO_LDSO}-sf";;
	esac
	cd src
	./make.bash
}

check() {
	cd src
	./run.bash --no-rebuild -k
}

package() {
	# clean source tree
	rm -rf pkg/bootstrap \
		pkg/obj
	# we want to keep test data around so users can have deeper go test
	# removing .bash, .rc etc isn't really worth it

	dbin="$pkgdir"/usr/bin
	dgo="$pkgdir"/"$GOROOT_FINAL"
	ddoc="$pkgdir"/usr/share/doc/"$pkgname"
	install -d \
		"$dbin" \
		"$dgo"/bin \
		"$ddoc"

	for binary in go gofmt; do
		install -Dm755 bin/"$binary" "$dgo"/bin/"$binary"
		ln -s "$GOROOT_FINAL"/bin/"$binary" "$dbin"
	done

	cp -a api lib misc pkg src test "$dgo"
	cp -a doc/* "$ddoc"
}

b2sums="9dacb150108dc30fe3600c6fdc1df3cd2c36f701518f402d2ad8cd2e4ba51203176e5097adf66ac9223181197b1bea7de625933c570567d9e7dddf485bc2c204  go1.14.6.src.tar.gz
6a99a1806eec94eae49de269f7ac572b28c79a758863bbec2800cb458eb6861437002e5cfc5fa7d7966de495ea520329d410def7a374dfc191f7beae7fbf41d3  dont_use_gold_arm64.patch
fda7a5ca2f69cf4f9810389109fb8cd2e29240f3db582cf1a626fcfdb3970fb34c0015f7e1185235f8819fe5679bf77da3fd3b28c465370ca2149ecbba0fb260  mips-fix-linker.patch
d8132d66d3e6a278d39b859a6db78968f91d4bf1996f716bc31589f21e7cc582de068cfa016a9c528848b05094ba2583e8f45e1db17e3c3614c94fee3e821861  fix-rlimit-syscall-aarch64-armv7.patch
112db77a50279c4671d6cd82fc52d48b8cff50269d0523535b43d5210636baf7fdca24bfcc3d8f63971ecf94414ffb0d9419029b5c8d67e7457fda9c1f5055fe  fix-setrlimit-hang.patch"
